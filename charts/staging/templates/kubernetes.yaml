{{- range .Values.services.kubernetes }}
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kubernetes-{{ .name }}
  namespace: {{ $.Values.namespace }}
  labels:
    cozystack.io/ui: "true"
spec:
  chart:
    spec:
      chart: kubernetes
      reconcileStrategy: Revision
      sourceRef:
        kind: HelmRepository
        name: cozystack-apps
        namespace: cozy-public
      version: 0.8.0
  interval: 1m0s
  timeout: 5m0s
  values:
    {{- toYaml .values | nindent 4 }}

{{- if .copySecrets }}
---
### COPY SECRET TO TENANT CLUSTER:
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kubernetes-{{ .name }}-copy-secrets
  namespace: {{ $.Values.namespace }}
spec:
  targetNamespace: default
  storageNamespace: default
  chart:
    spec:
      chart: ./charts/secret
      reconcileStrategy: Revision
      sourceRef:
        kind: GitRepository
        name: main
        namespace: tenant-root
      version: '*'
  interval: 1m0s
  timeout: 5m0s
  values:
    secret:
      metadata:
        name: secrets
        namespace: default
  valuesFrom:
    {{- range $secret := .copySecrets }}
    - kind: Secret
      name: {{ $secret.name }}
      #optional: true
      targetPath: {{ $secret.targetPath }}
      valuesKey: {{ $secret.valuesKey }}
    {{- end }}
  kubeConfig:
    secretRef:
      name: kubernetes-{{ .name }}-admin-kubeconfig
      key: super-admin.conf
  dependsOn:
  - name: kubernetes-{{ .name }}
{{- end }}

{{- end }}
